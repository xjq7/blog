# 性能优化

## 基础概念

### 性能衡量标准

- 首次绘制时间(FP)

  内容开始绘制时间

- 首次内容绘制时间(FCP)

  首次内容绘制指标测量页面从开始加载到页面内容的任何部分在屏幕上完成渲染的时间, 内容包含文本、图像（包括背景图）、svg 元素或者非白色的 canvas 元素

- 最大内容绘制时间(LCP)

  可视区域内可见的最大图像或文本块完成渲染的相对时间

- 首次交互时延(FID)

  FID 测量从用户第一次与页面交互（点击、轻触、按键等不连续操作）响应时间

- 持续可交互时间(TTI)

  TTI 指标测量页面从开始加载到主要子资源完成渲染， 并能够快速、可靠响应用户输入需要的时间

- 首字节接受时间(TTFB)

  TTFB 是衡量资源的第一个字节开始到抵达之间时间的指标

  影响 TTFB 指标的因素

  - 重定向
  - DNS 寻址时间
  - 建立连接与 TLS 消耗
  - 服务端响应， 从请求到响应的第一个字节到达的时延

- 累计布局偏移(CLS)

  布局偏移由布局不稳定性 API 定义,只要可视区域中可见元素的起始位置在两帧之间发生变更, 该 API 就会报告 layout-shift 条目。这样的元素被视为不稳定元素

### 帧率

帧率是指动画在每秒钟显示的帧数, 通常用 FPS 表示

## Chrome DevTools Performance

Chrome 浏览器开发工具中的一个功能板块, 用于分析网页性能, 帮助开发人员识别和解决性能问题

功能和用途:

- 性能分析

- 时间轴视图

- 记录和分析

- 分析报告

### 控制面板

![](https://image.xjq.icu/2024/7/19/1721394007744_image.png)

### 性能分析

#### 帧率分析

衡量动画性能主要指标是帧率, 正常 FPS 在 60 左右, 动画会比较流畅

通过查看帧绘制面板可以计算出当前动画不同时间段的帧率

![](https://image.xjq.icu/2024/7/24/1721790896405_Snipaste_2024-07-24_11-14-43.png)

这个面板头部是每一帧间隔, 我这里显示屏是 75 刷新率, 使用 1000/75 = 13.3 计算得到 每一帧绘制间隔是 13.3 ms, 大部分是 16.6 ms

然后下方是实际绘制的帧数, 可以看到, 实际过程中每 8 帧才绘制了一帧, 也就是说当前这段帧率在 75/8 ≈ 10帧左右

除了通过 Performance 去查看帧率之外, 还可以通过 js 代码计算

```Js
(function fps() {
  let lastTime = 0
  let frameCount = 0
  const _calFps = (currentTime) => {
    if (lastTime === 0) {
      lastTime = currentTime
    }

    frameCount++

    if (currentTime - lastTime >= 1000) {
      console.log('当前帧率: ' + frameCount)
      frameCount = 0
      lastTime = currentTime
    }
    requestAnimationFrame(_calFps)
  }
  requestAnimationFrame(_calFps)
})()
```

![](https://image.xjq.icu/2024/7/24/1721791391652_Snipaste_2024-07-24_11-23-04.png)

#### 性能瓶颈分析(运行时)

主面板数据分析

![](https://image.xjq.icu/2024/7/24/1721792976906_image-1.png)

各颜色块的含义

- 黄色块: Js 执行
- 紫色块: 样式计算和布局, 重排
- 绿色块: 重绘

![](https://image.xjq.icu/2024/7/24/1721792407352_Snipaste_2024-07-24_11-40-02.png)

点击函数调用黄色块可以查看耗时分布以及代码位置

![](https://image.xjq.icu/2024/7/24/1721801208538_Snipaste_2024-07-24_14-06-31.png)

查看具体耗时分布, 这里是重排耗时最高

![](https://image.xjq.icu/2024/7/24/1721801489691_Snipaste_2024-07-24_14-10-10.png)

我们可以继续点击重排的紫色块查看摘要信息

![](https://image.xjq.icu/2024/7/24/1721802195807_image.png)

从摘要进入查看代码每行耗时

![](https://image.xjq.icu/2024/7/24/1721802176304_image-2.png)

这里可以看到性能耗时主要在于 70、71 行

70 行是方块位置更新动作, 触发重排是正常的

71 行由于使用了 offsetTop 属性触发了重排, 优化这行代码动画性能可以得到大幅提升

#### 网络性能分析

点击控制面板这个按钮 重新加载网页分析加载性能

![](https://image.xjq.icu/2024/7/24/1721804317078_image.png)

在网络板块可以看到所有资源的加载链路, 包含起始时间, 加载时长等信息

我们可以检索哪些资源加载时间过长, 并且对其他资源有阻塞效果, 来进行优化

![](https://image.xjq.icu/2024/7/24/1721804319508_image-1.png)

时间板块可以看到各个性能指标时间节点, 各个指标含义点击[性能衡量标准](#性能衡量标准)查看

![](https://image.xjq.icu/2024/7/24/1721804321211_image-2.png)

### CSS 选择器性能分析

## 优化

### 重排
